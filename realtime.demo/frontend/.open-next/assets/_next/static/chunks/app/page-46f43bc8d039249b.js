(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{8278:function(e,t,s){Promise.resolve().then(s.bind(s,7215))},7215:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return w}});var n=s(7437),a=s(2265);let r=(0,s(1545).eI)("https://qcxnwhfmfskaqxryzptz.supabase.co","sb_publishable_-Sy692JpiubhEy-Zp4b41Q_fCRWuj6h");var o=s(738),i=s(7012);let l=0===(0,o.C6)().length?(0,o.ZF)({apiKey:"AIzaSyDJGvjxRunvADv05o2VHQg--Q-U_kZbUao",authDomain:"pwa-push-demo-5a61e.firebaseapp.com",projectId:"pwa-push-demo-5a61e",storageBucket:"pwa-push-demo-5a61e.firebasestorage.app",messagingSenderId:"404242458499",appId:"1:404242458499:web:3117487115e23fde66b8b6",measurementId:"G-8P0ZW84W6L"}):(0,o.C6)()[0],c=null,d=!1;async function u(){if(!("serviceWorker"in navigator))return console.warn("[FCM] Service Worker not supported"),null;if(!await (0,i.Gb)())return console.error("[FCM] Messaging API not supported in this browser"),null;if(!c)try{c=(0,i.KL)(l),console.log("[FCM] Messaging instance initialized successfully")}catch(e){return console.error("[FCM] Failed to initialize Messaging:",e),null}return c}async function g(e){if(!e)return console.error("[FCM] Missing VAPID key. Set NEXT_PUBLIC_FCM_VAPID_KEY."),null;let t=await u();if(!t)return console.warn("[FCM] Messaging not available"),null;try{let s=await navigator.serviceWorker.ready;console.log("[FCM] Using service worker registration:",s);let n=await (0,i.LP)(t,{vapidKey:e,serviceWorkerRegistration:s});return console.log("[FCM] token",n),n}catch(e){return console.error("[FCM] Failed to get token:",e),null}}async function m(e){let t=await u();if(!t){console.warn("[FCM] Messaging not available");return}if(d){console.log("[FCM] Message listener already setup, skipping...");return}console.log("[FCM] Setting up foreground message listener..."),d=!0,(0,i.ps)(t,t=>{var s,n,a,r,o,i,l;console.log("[FCM] foreground payload:",t);let c=(null===(s=t.notification)||void 0===s?void 0:s.title)||(null===(n=t.data)||void 0===n?void 0:n.title)||"New Message",d=(null===(a=t.notification)||void 0===a?void 0:a.body)||(null===(r=t.data)||void 0===r?void 0:r.body)||"",u=(null==t?void 0:null===(o=t.fcmOptions)||void 0===o?void 0:o.link)||(null===(i=t.data)||void 0===i?void 0:i.url)||"/";if("Notification"in window&&"granted"===Notification.permission){let e=new Notification(c,{body:d,icon:"/icon-192.png",badge:"/icon-192.png",data:{url:u}});e.onclick=()=>{window.focus(),u&&"/"!==u&&(window.location.href=u),e.close()}}else console.warn("[FCM] Cannot show notification - Permission:",null===(l=Notification)||void 0===l?void 0:l.permission);e(t)}),console.log("[FCM] Foreground message listener setup complete")}let h="http://localhost:8787";async function p(){if(!("serviceWorker"in navigator))return console.warn("[FCM] Service Worker not supported"),null;try{let e=await navigator.serviceWorker.getRegistration("/firebase-messaging-sw.js");if(e)return console.log("[FCM] Service Worker already registered:",e),await e.update(),e;let t=await navigator.serviceWorker.register("/firebase-messaging-sw.js",{scope:"/"});return console.log("[FCM] Service Worker registered:",t),await navigator.serviceWorker.ready,console.log("[FCM] Service Worker ready!"),t}catch(e){return console.error("[FCM] Service Worker registration failed:",e),null}}async function f(){if(!("Notification"in window))return console.warn("[FCM] Notifications not supported"),"denied";let e=await Notification.requestPermission();return console.log("[FCM] Notification permission:",e),e}async function x(){console.log("[FCM] Setting up message listener..."),await m(e=>{console.log("[FCM] Message received in app:",e)})}async function b(e){try{console.log("[FCM] Starting subscription process for user:",e),console.log("[FCM] Waiting for service worker..."),await navigator.serviceWorker.ready,console.log("[FCM] Service worker ready!"),console.log("[FCM] Requesting FCM token with VAPID key...");let t=await g("BE2iSLa-FL5AVipAlX83gtTLbWhO52btG2t4w7lTRwyTgBRaDNKCHMs_YsYVJq6qkLFIIDZ8Y8J21GCDnLvoEeo");if(!t)return console.error("[FCM] Failed to get FCM token"),!1;console.log("[FCM] Token obtained:",t),console.log("[FCM] Saving token to BFF:",h);let s=await fetch("".concat(h,"/api/fcm/subscribe"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,fcmToken:t})});if(!s.ok){let e=await s.text();return console.error("[FCM] Failed to save token:",s.status,e),!1}return console.log("[FCM] Token saved to BFF"),console.log("[FCM] Subscription completed successfully!"),!0}catch(e){return console.error("[FCM] Subscription failed:",e),!1}}async function v(e){try{let t=await fetch("".concat(h,"/api/fcm/send"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,title:"テスト通知",body:"これはFCM経由のテスト通知です！",url:"/"})});if(!t.ok){let e=await t.text();return console.error("[FCM] Failed to send test notification:",t.status,e),!1}return console.log("[FCM] Test notification sent!"),!0}catch(e){return console.error("[FCM] Error sending test notification:",e),!1}}async function y(e,t,s){try{console.log("[FCM] Sending message via BFF:",{fromUserId:e,toUserId:t,message:s});let n=await fetch("".concat(h,"/api/thanks"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromUserId:e,toUserId:t,message:s})});if(!n.ok){let e=await n.text();return console.error("[FCM] Failed to send message:",n.status,e),!1}return console.log("[FCM] Message sent successfully"),!0}catch(e){return console.error("[FCM] Error sending message:",e),!1}}function w(){let[e,t]=(0,a.useState)(""),[s,o]=(0,a.useState)(""),[i,l]=(0,a.useState)(""),[c,d]=(0,a.useState)([]),[u,g]=(0,a.useState)(""),[m,h]=(0,a.useState)(!1),[w,C]=(0,a.useState)(!1),[F,N]=(0,a.useState)("default"),M=(0,a.useRef)(null),j=(0,a.useCallback)(async e=>{if(!e)return;let{data:t,error:s}=await r.from("messages").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(20);s?console.error("Load messages error:",s):d(t||[])},[]);(0,a.useEffect)(()=>{let e="user_".concat(Math.random().toString(36).slice(2,11));t(e),o(e),l(e),C(window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone),"Notification"in window&&N(Notification.permission),p(),x(),j(e)},[j]),(0,a.useEffect)(()=>{if(!i)return;M.current&&(r.removeChannel(M.current),M.current=null);let e=r.channel("messages:user:".concat(i)).on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:"user_id=eq.".concat(i)},e=>{console.log("[RT] messages change",e),d(t=>{switch(e.eventType){case"INSERT":{let s=e.new;return[s,...t.filter(e=>e.id!==s.id)].sort((e,t)=>e.created_at>t.created_at?-1:1).slice(0,20)}case"UPDATE":{let s=e.new;return t.map(e=>e.id===s.id?s:e).sort((e,t)=>e.created_at>t.created_at?-1:1)}case"DELETE":{var s;let n=null===(s=e.old)||void 0===s?void 0:s.id;if(!n)return t;return t.filter(e=>e.id!==n)}default:return t}})}).subscribe();return M.current=e,j(i),()=>{r.removeChannel(e),M.current=null}},[i,j]);let k=async()=>{if(!u.trim())return;if(!e){alert("ユーザーIDを生成中です。数秒後に再度お試しください。");return}let t=u.trim(),n=s.trim()||e;if(!await y(e,n,t)){alert("メッセージ送信に失敗しました");return}console.log("[UI] Message sent:",{from:e,to:n,message:t}),n===e&&await j(e),g("")},S=async()=>{try{console.log("[UI] Starting push enable process...");let t=await f();if(console.log("[UI] Permission result:",t),N(t),"granted"===t){console.log("[UI] Calling subscribeToPush...");let t=await b(e);console.log("[UI] Subscribe result:",t),h(t),t?alert("✅ Push通知が有効になりました！"):alert("❌ Push通知の有効化に失敗しました")}else alert("⚠️ 通知許可が必要です")}catch(e){console.error("[UI] Enable push error:",e),alert("❌ エラーが発生しました: "+e)}},D=async()=>{await v(e)?alert("✅ テスト通知を送信しました！\n（アプリを閉じて確認してください）"):alert("❌ テスト通知の送信に失敗しました")};return(0,n.jsx)("div",{className:"min-h-screen bg-gray-50 p-4",children:(0,n.jsxs)("div",{className:"max-w-2xl mx-auto",children:[(0,n.jsx)("h1",{className:"text-3xl font-bold mb-2",children:"PWA Push Demo"}),(0,n.jsxs)("p",{className:"text-sm text-gray-600 mb-6",children:["User ID: ",e||"読み込み中..."]}),(0,n.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,n.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDD14 Push通知設定"}),(0,n.jsxs)("div",{className:"space-y-3 mb-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("span",{className:"text-sm",children:"PWAモード（A2HS）:"}),(0,n.jsx)("span",{className:"text-sm font-medium ".concat(w?"text-green-600":"text-orange-600"),children:w?"✅ 有効":"⚠️ 無効"})]}),(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("span",{className:"text-sm",children:"通知許可:"}),(0,n.jsx)("span",{className:"text-sm font-medium ".concat("granted"===F?"text-green-600":"denied"===F?"text-red-600":"text-gray-600"),children:"granted"===F?"✅ 許可":"denied"===F?"❌ 拒否":"⏳ 未設定"})]}),(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("span",{className:"text-sm",children:"Push購読:"}),(0,n.jsx)("span",{className:"text-sm font-medium ".concat(m?"text-green-600":"text-gray-600"),children:m?"✅ 有効":"⏳ 未設定"})]})]}),!w&&(0,n.jsxs)("div",{className:"bg-orange-50 border border-orange-200 rounded p-3 mb-4 text-sm",children:[(0,n.jsx)("p",{className:"font-medium text-orange-800 mb-1",children:"\uD83D\uDCF1 iOSで通知を受け取るには"}),(0,n.jsxs)("ol",{className:"list-decimal list-inside text-orange-700 space-y-1",children:[(0,n.jsx)("li",{children:"Safariの共有ボタンをタップ"}),(0,n.jsx)("li",{children:"「ホーム画面に追加」を選択"}),(0,n.jsx)("li",{children:"ホーム画面から起動"})]})]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)("button",{onClick:S,disabled:m,className:"flex-1 bg-blue-600 text-white px-4 py-2 rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700",children:m?"Push購読済み":"Push通知を有効化"}),(0,n.jsx)("button",{onClick:D,disabled:!m,className:"flex-1 bg-green-600 text-white px-4 py-2 rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-700",children:"テスト通知"})]})]}),(0,n.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,n.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDCAC メッセージ送信"}),(0,n.jsx)("p",{className:"text-sm text-gray-600 mb-3",children:"メッセージを送信すると、Realtime経由で即座に画面が更新されます"}),(0,n.jsxs)("div",{className:"mb-3",children:[(0,n.jsx)("label",{className:"text-sm text-gray-600 block mb-1",children:"送り先ユーザーID（未指定なら自分宛て）"}),(0,n.jsx)("input",{type:"text",value:s,onChange:e=>o(e.target.value),className:"w-full border rounded px-3 py-2"}),(0,n.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"別端末で Push を受け取りたい場合は、その端末の User ID を入力してください。"})]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)("input",{type:"text",value:u,onChange:e=>g(e.target.value),onKeyDown:e=>"Enter"===e.key&&k(),placeholder:"メッセージを入力...",className:"flex-1 border rounded px-3 py-2"}),(0,n.jsx)("button",{onClick:k,className:"bg-blue-600 text-white px-6 py-2 rounded font-medium hover:bg-blue-700",children:"送信"})]}),(0,n.jsxs)("div",{className:"mt-3 flex gap-2",children:[(0,n.jsx)("button",{onClick:()=>{s.trim()&&(l(s.trim()),j(s.trim()))},className:"bg-gray-200 text-gray-800 px-4 py-2 rounded font-medium hover:bg-gray-300",children:"表示をこのユーザーに切替"}),(0,n.jsx)("button",{onClick:()=>{e&&(l(e),j(e))},className:"bg-gray-200 text-gray-800 px-4 py-2 rounded font-medium hover:bg-gray-300",children:"自分宛の表示に戻す"})]})]}),(0,n.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,n.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDCDD メッセージ一覧"}),(0,n.jsx)("div",{className:"space-y-2",children:0===c.length?(0,n.jsx)("p",{className:"text-gray-500 text-sm",children:"まだメッセージがありません"}):c.map(e=>(0,n.jsxs)("div",{className:"border-b pb-2",children:[(0,n.jsx)("p",{className:"text-sm font-medium",children:e.content}),(0,n.jsxs)("p",{className:"text-xs text-gray-500",children:[e.user_id," \xb7 ",new Date(e.created_at).toLocaleString("ja-JP")]})]},e.id))})]})]})})}}},function(e){e.O(0,[388,971,117,744],function(){return e(e.s=8278)}),_N_E=e.O()}]);