(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{8278:function(e,s,t){Promise.resolve().then(t.bind(t,8688))},8688:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return u}});var a=t(7437),n=t(2265);let r=(0,t(1545).eI)("https://qcxnwhfmfskaqxryzptz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjeG53aGZtZnNrYXF4cnl6cHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MTU1MjMsImV4cCI6MjA3NzE5MTUyM30.folnOdee06XZ0o_Gz5mzuQyphXXVeJiLSJnpApulwig"),i="https://pwa-push-demo-bff.fleatoke.workers.dev";async function o(){if(!("serviceWorker"in navigator))return console.warn("Service Worker not supported"),null;try{let e=await navigator.serviceWorker.register("/sw.js");return console.log("[Push] Service Worker registered:",e),e}catch(e){return console.error("[Push] Service Worker registration failed:",e),null}}async function l(){if(!("Notification"in window))return console.warn("Notifications not supported"),"denied";let e=await Notification.requestPermission();return console.log("[Push] Notification permission:",e),e}async function c(e){try{let s=await navigator.serviceWorker.ready,t=await s.pushManager.getSubscription();if(!t){let e=function(e){let s="=".repeat((4-e.length%4)%4),t=(e+s).replace(/-/g,"+").replace(/_/g,"/"),a=window.atob(t),n=new Uint8Array(a.length);for(let e=0;e<a.length;++e)n[e]=a.charCodeAt(e);return n}("BGiIDYRNL-sa7Dp8UGYuf0ICZ4voSM7xKckuqyGB1N13fQyzeibls2ohvQqWiOumcQ9sV0mPPRtiCSgDLxfe3sg");t=await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e})}if(console.log("[Push] Subscription:",t),!(await fetch("".concat(i,"/api/push/subscribe"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,subscription:t.toJSON()})})).ok)throw Error("Failed to save subscription");return console.log("[Push] Subscription saved to BFF"),!0}catch(e){return console.error("[Push] Subscribe error:",e),!1}}async function d(e){try{return(await fetch("".concat(i,"/api/push/send"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,title:"テスト通知",body:"これはテスト通知です",url:"/"})})).ok}catch(e){return console.error("[Push] Send test notification error:",e),!1}}function u(){let[e,s]=(0,n.useState)(""),[t,i]=(0,n.useState)([]),[u,m]=(0,n.useState)(""),[h,x]=(0,n.useState)(!1),[p,b]=(0,n.useState)(!1),[g,f]=(0,n.useState)("default");(0,n.useEffect)(()=>{s("user_".concat(Math.random().toString(36).slice(2,11))),b(window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone),"Notification"in window&&f(Notification.permission),o(),N();let e=r.channel("messages").on("postgres_changes",{event:"*",schema:"public",table:"messages"},e=>{console.log("[Realtime] Change received:",e),N()}).subscribe();return()=>{r.removeChannel(e)}},[]);let N=async()=>{let{data:e,error:s}=await r.from("messages").select("*").order("created_at",{ascending:!1}).limit(10);s?console.error("Load messages error:",s):i(e||[])},y=async()=>{if(!u.trim())return;let{error:s}=await r.from("messages").insert({user_id:e,content:u});s?(console.error("Send message error:",s),alert("メッセージ送信に失敗しました")):m("")},w=async()=>{let s=await l();if(f(s),"granted"===s){let s=await c(e);x(s),s?alert("✅ Push通知が有効になりました！"):alert("❌ Push通知の有効化に失敗しました")}},j=async()=>{await d(e)?alert("✅ テスト通知を送信しました！\n（アプリを閉じて確認してください）"):alert("❌ テスト通知の送信に失敗しました")};return(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 p-4",children:(0,a.jsxs)("div",{className:"max-w-2xl mx-auto",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold mb-2",children:"PWA Push Demo"}),(0,a.jsxs)("p",{className:"text-sm text-gray-600 mb-6",children:["User ID: ",e||"読み込み中..."]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDD14 Push通知設定"}),(0,a.jsxs)("div",{className:"space-y-3 mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm",children:"PWAモード（A2HS）:"}),(0,a.jsx)("span",{className:"text-sm font-medium ".concat(p?"text-green-600":"text-orange-600"),children:p?"✅ 有効":"⚠️ 無効"})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm",children:"通知許可:"}),(0,a.jsx)("span",{className:"text-sm font-medium ".concat("granted"===g?"text-green-600":"denied"===g?"text-red-600":"text-gray-600"),children:"granted"===g?"✅ 許可":"denied"===g?"❌ 拒否":"⏳ 未設定"})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm",children:"Push購読:"}),(0,a.jsx)("span",{className:"text-sm font-medium ".concat(h?"text-green-600":"text-gray-600"),children:h?"✅ 有効":"⏳ 未設定"})]})]}),!p&&(0,a.jsxs)("div",{className:"bg-orange-50 border border-orange-200 rounded p-3 mb-4 text-sm",children:[(0,a.jsx)("p",{className:"font-medium text-orange-800 mb-1",children:"\uD83D\uDCF1 iOSで通知を受け取るには"}),(0,a.jsxs)("ol",{className:"list-decimal list-inside text-orange-700 space-y-1",children:[(0,a.jsx)("li",{children:"Safariの共有ボタンをタップ"}),(0,a.jsx)("li",{children:"「ホーム画面に追加」を選択"}),(0,a.jsx)("li",{children:"ホーム画面から起動"})]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{onClick:w,disabled:h,className:"flex-1 bg-blue-600 text-white px-4 py-2 rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700",children:h?"Push購読済み":"Push通知を有効化"}),(0,a.jsx)("button",{onClick:j,disabled:!h,className:"flex-1 bg-green-600 text-white px-4 py-2 rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-700",children:"テスト通知"})]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDCAC メッセージ送信"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mb-3",children:"メッセージを送信すると、Realtime経由で即座に画面が更新されます"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"text",value:u,onChange:e=>m(e.target.value),onKeyDown:e=>"Enter"===e.key&&y(),placeholder:"メッセージを入力...",className:"flex-1 border rounded px-3 py-2"}),(0,a.jsx)("button",{onClick:y,className:"bg-blue-600 text-white px-6 py-2 rounded font-medium hover:bg-blue-700",children:"送信"})]})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDCDD メッセージ一覧"}),(0,a.jsx)("div",{className:"space-y-2",children:0===t.length?(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"まだメッセージがありません"}):t.map(e=>(0,a.jsxs)("div",{className:"border-b pb-2",children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:e.content}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:[e.user_id," \xb7 ",new Date(e.created_at).toLocaleString("ja-JP")]})]},e.id))})]})]})})}}},function(e){e.O(0,[545,971,117,744],function(){return e(e.s=8278)}),_N_E=e.O()}]);