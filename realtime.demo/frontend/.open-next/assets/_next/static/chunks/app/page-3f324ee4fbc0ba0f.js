(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{8278:function(e,t,s){Promise.resolve().then(s.bind(s,7215))},7215:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return v}});var o=s(7437),n=s(2265);let i=(0,s(1545).eI)("https://qcxnwhfmfskaqxryzptz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjeG53aGZtZnNrYXF4cnl6cHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MTU1MjMsImV4cCI6MjA3NzE5MTUyM30.folnOdee06XZ0o_Gz5mzuQyphXXVeJiLSJnpApulwig");var a=s(738),r=s(7012);let l=0===(0,a.C6)().length?(0,a.ZF)({apiKey:"AIzaSyDJGvjxRunvADv05o2VHQg--Q-U_kZbUao",authDomain:"pwa-push-demo-5a61e.firebaseapp.com",projectId:"pwa-push-demo-5a61e",storageBucket:"pwa-push-demo-5a61e.firebasestorage.app",messagingSenderId:"404242458499",appId:"1:404242458499:web:3117487115e23fde66b8b6",measurementId:"G-8P0ZW84W6L"}):(0,a.C6)()[0],c=null,d=!1;async function u(){if(!("serviceWorker"in navigator))return console.warn("[FCM] Service Worker not supported"),null;if(!await (0,r.Gb)())return console.error("[FCM] Messaging API not supported in this browser"),null;if(!c)try{c=(0,r.KL)(l),console.log("[FCM] Messaging instance initialized successfully")}catch(e){return console.error("[FCM] Failed to initialize Messaging:",e),null}return c}async function g(e){let t=await u();if(!t)return console.warn("[FCM] Messaging not available"),null;try{let s=await navigator.serviceWorker.ready;console.log("[FCM] Using service worker registration:",s);let o=await (0,r.LP)(t,{vapidKey:e,serviceWorkerRegistration:s});return console.log("[FCM] Token obtained:",o),o}catch(e){return console.error("[FCM] Failed to get token:",e),null}}async function m(e){let t=await u();if(!t){console.warn("[FCM] Messaging not available");return}if(d){console.log("[FCM] Message listener already setup, skipping...");return}console.log("[FCM] Setting up foreground message listener..."),d=!0,(0,r.ps)(t,t=>{var s,o,n,i,a,r,l;console.log("[FCM] Foreground message received:",t),console.log("[FCM] Payload data:",t.data),console.log("[FCM] Payload notification:",t.notification);let c=(null===(s=t.data)||void 0===s?void 0:s.title)||(null===(o=t.notification)||void 0===o?void 0:o.title)||"New Message",d=(null===(n=t.data)||void 0===n?void 0:n.body)||(null===(i=t.notification)||void 0===i?void 0:i.body)||"",u=(null===(a=t.data)||void 0===a?void 0:a.url)||(null===(r=t.fcmOptions)||void 0===r?void 0:r.link)||"/";if(console.log("[FCM] Extracted - Title:",c,"Body:",d,"URL:",u),"Notification"in window&&"granted"===Notification.permission){console.log("[FCM] Creating notification...");let e=new Notification(c,{body:d,icon:"/icon-192.png",badge:"/icon-192.png",data:{url:u}});console.log("[FCM] Notification created:",e),e.onclick=()=>{console.log("[FCM] Notification clicked"),window.focus(),u&&"/"!==u&&(window.location.href=u),e.close()}}else console.warn("[FCM] Cannot show notification - Permission:",null===(l=Notification)||void 0===l?void 0:l.permission);e(t)}),console.log("[FCM] Foreground message listener setup complete")}let p="https://pwa-push-demo-bff.fleatoke.workers.dev";async function f(){if(!("serviceWorker"in navigator))return console.warn("[FCM] Service Worker not supported"),null;try{let e=await navigator.serviceWorker.getRegistration("/firebase-messaging-sw.js");if(e)return console.log("[FCM] Service Worker already registered:",e),await e.update(),e;let t=await navigator.serviceWorker.register("/firebase-messaging-sw.js",{scope:"/"});return console.log("[FCM] Service Worker registered:",t),await navigator.serviceWorker.ready,console.log("[FCM] Service Worker ready!"),t}catch(e){return console.error("[FCM] Service Worker registration failed:",e),null}}async function h(){if(!("Notification"in window))return console.warn("[FCM] Notifications not supported"),"denied";let e=await Notification.requestPermission();return console.log("[FCM] Notification permission:",e),e}async function x(){console.log("[FCM] Setting up message listener..."),await m(e=>{console.log("[FCM] Message received in app:",e)})}async function b(e){try{console.log("[FCM] Starting subscription process for user:",e),console.log("[FCM] Waiting for service worker..."),await navigator.serviceWorker.ready,console.log("[FCM] Service worker ready!"),console.log("[FCM] Requesting FCM token with VAPID key...");let t=await g("BE2iSLa-FL5AVipAlX83gtTLbWhO52btG2t4w7lTRwyTgBRaDNKCHMs_YsYVJq6qkLFIIDZ8Y8J21GCDnLvoEeo");if(!t)return console.error("[FCM] Failed to get FCM token"),!1;console.log("[FCM] Token obtained:",t),console.log("[FCM] Saving token to BFF:",p);let s=await fetch("".concat(p,"/api/fcm/subscribe"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,fcmToken:t})});if(!s.ok){let e=await s.text();return console.error("[FCM] Failed to save token:",s.status,e),!1}return console.log("[FCM] Token saved to BFF"),console.log("[FCM] Subscription completed successfully!"),!0}catch(e){return console.error("[FCM] Subscription failed:",e),!1}}async function w(e){try{let t=await fetch("".concat(p,"/api/fcm/send"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,title:"テスト通知",body:"これはFCM経由のテスト通知です！",url:"/"})});if(!t.ok){let e=await t.text();return console.error("[FCM] Failed to send test notification:",t.status,e),!1}return console.log("[FCM] Test notification sent!"),!0}catch(e){return console.error("[FCM] Error sending test notification:",e),!1}}function v(){let[e,t]=(0,n.useState)(""),[s,a]=(0,n.useState)([]),[r,l]=(0,n.useState)(""),[c,d]=(0,n.useState)(!1),[u,g]=(0,n.useState)(!1),[m,p]=(0,n.useState)("default");(0,n.useEffect)(()=>{t("user_".concat(Math.random().toString(36).slice(2,11))),g(window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone),"Notification"in window&&p(Notification.permission),f(),x(),v();let e=i.channel("messages").on("postgres_changes",{event:"*",schema:"public",table:"messages"},e=>{console.log("[Realtime] Change received:",e),v()}).subscribe();return()=>{i.removeChannel(e)}},[]);let v=async()=>{let{data:e,error:t}=await i.from("messages").select("*").order("created_at",{ascending:!1}).limit(10);t?console.error("Load messages error:",t):a(e||[])},y=async()=>{if(!r.trim())return;let{error:t}=await i.from("messages").insert({user_id:e,content:r});t?(console.error("Send message error:",t),alert("メッセージ送信に失敗しました")):l("")},C=async()=>{try{console.log("[UI] Starting push enable process...");let t=await h();if(console.log("[UI] Permission result:",t),p(t),"granted"===t){console.log("[UI] Calling subscribeToPush...");let t=await b(e);console.log("[UI] Subscribe result:",t),d(t),t?alert("✅ Push通知が有効になりました！"):alert("❌ Push通知の有効化に失敗しました")}else alert("⚠️ 通知許可が必要です")}catch(e){console.error("[UI] Enable push error:",e),alert("❌ エラーが発生しました: "+e)}},F=async()=>{await w(e)?alert("✅ テスト通知を送信しました！\n（アプリを閉じて確認してください）"):alert("❌ テスト通知の送信に失敗しました")};return(0,o.jsx)("div",{className:"min-h-screen bg-gray-50 p-4",children:(0,o.jsxs)("div",{className:"max-w-2xl mx-auto",children:[(0,o.jsx)("h1",{className:"text-3xl font-bold mb-2",children:"PWA Push Demo"}),(0,o.jsxs)("p",{className:"text-sm text-gray-600 mb-6",children:["User ID: ",e||"読み込み中..."]}),(0,o.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDD14 Push通知設定"}),(0,o.jsxs)("div",{className:"space-y-3 mb-4",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between",children:[(0,o.jsx)("span",{className:"text-sm",children:"PWAモード（A2HS）:"}),(0,o.jsx)("span",{className:"text-sm font-medium ".concat(u?"text-green-600":"text-orange-600"),children:u?"✅ 有効":"⚠️ 無効"})]}),(0,o.jsxs)("div",{className:"flex items-center justify-between",children:[(0,o.jsx)("span",{className:"text-sm",children:"通知許可:"}),(0,o.jsx)("span",{className:"text-sm font-medium ".concat("granted"===m?"text-green-600":"denied"===m?"text-red-600":"text-gray-600"),children:"granted"===m?"✅ 許可":"denied"===m?"❌ 拒否":"⏳ 未設定"})]}),(0,o.jsxs)("div",{className:"flex items-center justify-between",children:[(0,o.jsx)("span",{className:"text-sm",children:"Push購読:"}),(0,o.jsx)("span",{className:"text-sm font-medium ".concat(c?"text-green-600":"text-gray-600"),children:c?"✅ 有効":"⏳ 未設定"})]})]}),!u&&(0,o.jsxs)("div",{className:"bg-orange-50 border border-orange-200 rounded p-3 mb-4 text-sm",children:[(0,o.jsx)("p",{className:"font-medium text-orange-800 mb-1",children:"\uD83D\uDCF1 iOSで通知を受け取るには"}),(0,o.jsxs)("ol",{className:"list-decimal list-inside text-orange-700 space-y-1",children:[(0,o.jsx)("li",{children:"Safariの共有ボタンをタップ"}),(0,o.jsx)("li",{children:"「ホーム画面に追加」を選択"}),(0,o.jsx)("li",{children:"ホーム画面から起動"})]})]}),(0,o.jsxs)("div",{className:"flex gap-2",children:[(0,o.jsx)("button",{onClick:C,disabled:c,className:"flex-1 bg-blue-600 text-white px-4 py-2 rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700",children:c?"Push購読済み":"Push通知を有効化"}),(0,o.jsx)("button",{onClick:F,disabled:!c,className:"flex-1 bg-green-600 text-white px-4 py-2 rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-700",children:"テスト通知"})]})]}),(0,o.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 mb-6",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDCAC メッセージ送信"}),(0,o.jsx)("p",{className:"text-sm text-gray-600 mb-3",children:"メッセージを送信すると、Realtime経由で即座に画面が更新されます"}),(0,o.jsxs)("div",{className:"flex gap-2",children:[(0,o.jsx)("input",{type:"text",value:r,onChange:e=>l(e.target.value),onKeyDown:e=>"Enter"===e.key&&y(),placeholder:"メッセージを入力...",className:"flex-1 border rounded px-3 py-2"}),(0,o.jsx)("button",{onClick:y,className:"bg-blue-600 text-white px-6 py-2 rounded font-medium hover:bg-blue-700",children:"送信"})]})]}),(0,o.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDCDD メッセージ一覧"}),(0,o.jsx)("div",{className:"space-y-2",children:0===s.length?(0,o.jsx)("p",{className:"text-gray-500 text-sm",children:"まだメッセージがありません"}):s.map(e=>(0,o.jsxs)("div",{className:"border-b pb-2",children:[(0,o.jsx)("p",{className:"text-sm font-medium",children:e.content}),(0,o.jsxs)("p",{className:"text-xs text-gray-500",children:[e.user_id," \xb7 ",new Date(e.created_at).toLocaleString("ja-JP")]})]},e.id))})]})]})})}}},function(e){e.O(0,[388,971,117,744],function(){return e(e.s=8278)}),_N_E=e.O()}]);